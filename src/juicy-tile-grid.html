<!-- Import Polymer -->
<!-- <link rel="import" href="../../polymer/polymer.html"> -->
<!-- Import juicy-tile-list -->
<link rel="import" href="../../juicy-tile-list/src/juicy-tile-list.html">

<!-- Define your custom element -->
<polymer-element name="juicy-tile-grid" extends="juicy-tile-list" noscript>

    <template>
    <style>
        :host {
            display: inline-block;
            padding: 16px;
        }
        #container{
          display:grid;
          grid-template-rows: 50px 50px;
          grid-template-columns: 50px 50px 50px 100px;

          grid-auto-columns: 100px;
          grid-auto-rows: 100px;
          display:-moz-grid;
          -moz-grid-auto-columns: 100px;
          -moz-grid-auto-rows: 100px;
        }
        polyfill-next-selector { content: ':host #container> *'; }
        #container ::content>*,
        #container >*  {
            position: static;
        }
        polyfill-next-selector { content: ':host #container.animate> *'; }
        #container.animate ::content>*,
        #container.animate >*  {
            -webkit-transition: width 0.5s, height 0.5s, top 0.5s, left 0.5s, -webkit-transform 0.5s;
            transition: width 0.5s, height 0.5s, top 0.5s, left 0.5s, transform 0.5s;
            transition-timing-function: ease-out;
        }
    </style>

    <div id="container" class="animate"><content></content></div>
    </template>
    <script>
        Polymer('juicy-tile-grid', {
            renderer: function grid( packedTree, elements, offsetX, offsetY ){
                var cols = []; // just position //{position: px, size: px [, gap: bool]}
                var rows = []; // {position: px, size: px [, gap: bool]}
                var renderedGrid = []; //{index: n, name: groupname, row: r, column: c, background, innerHTML, oversize}

                function drawLine( array, position ){
                    var len = array.length;
                    while(len-- && array[len] > position){  // array[len].position > position){  
                    }
                    if(len>-1 && array[len] == position){ // array[len].position == position){
                        return len;
                    } else {
                        array.splice( len+1, 0, position ); // {position: position});
                        return len+1;
                    }
                    return len;
                }
                function drawLinesFromTree( node, offsetX, offsetY ){
                    var ilen = node.items.length;
                    while(ilen--){
                        var item = node.items[ilen];
                        drawLine(cols, offsetX + item.x);
                        drawLine(cols, offsetX + item.x + item.width);

                        drawLine(rows, offsetY + item.y);
                        drawLine(rows, offsetY + item.y + item.height);

                        if(item.items){
                            drawLinesFromTree( item, offsetX + item.x, offsetY + item.y);
                        }
                    }
                }
                drawLinesFromTree(packedTree, 0,0);

                function renderGrid(node, elements, offsetX, offsetY){
                    var childNodeNo = node.items.length,
                        child,
                        element, elementStyle, left, top, colNo, rowNo;  
                    while(childNodeNo--){
                        child = node.items[childNodeNo]
                        element = elements[ child.name || child.index ];
                        elementStyle = element.style;
                        left = ( child.x || 0 ) + offsetX; 
                        top = ( child.y || 0 ) + offsetY;
                        var oversize = child.oversize || 0;
                        colNo = cols.indexOf( left ); 
                        rowNo = rows.indexOf( top ); 
                        // cols are 1 index based
                        elementStyle["grid-column"] = ( colNo + 1 ) + " / span " + ( cols.indexOf( left + child.width ) - colNo );
                        elementStyle["-ms-grid-column"] = ( colNo + 1 ) + " / span " + ( cols.indexOf( left + child.width ) - colNo );
                        // rows are 1 index based
                        elementStyle["grid-row"]= ( rowNo + 1 ) + " / span " + ( rows.indexOf( top + child.height ) -rowNo );
                        elementStyle["-ms-grid-row"]= ( rowNo + 1 ) + " / span " + ( rows.indexOf( top + child.height ) -rowNo );
                        elementStyle.width = ( child.width /*+ 2 * oversize*/ ) + "px";
                        elementStyle.height = ( child.height /*+ 2 * oversize*/ ) + "px";
                        if(child.background !== undefined) {
                        elementStyle.backgroundColor = child.background || "transparent";
                        }

                        if(child.items){// virtual container
                            renderGrid( child, elements, left, top);
                        }
                    }
                }

                function lineWidths(array){
                    var alen = array.length,
                        str = "";
                    while(alen-- >1){
                        str = (array[alen] - array[alen-1]) + "px " + str;
                    }
                    return str;
                }
                var containerStyle = this.$.container.style;
                containerStyle.display = "-ms-grid";
                // containerStyle.display = "grid";
                renderGrid( packedTree, elements, 0,0);

                containerStyle["grid-template-columns"] = containerStyle["-ms-grid-columns"] = 
                    lineWidths(cols);
                containerStyle["grid-template-rows"] = containerStyle["-ms-grid-rows"] = 
                    lineWidths(rows);


              
            }
        });
    </script>

</polymer-element>
