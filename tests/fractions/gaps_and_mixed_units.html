<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">

    <script src="../../../webcomponentsjs/webcomponents.js"></script>
    <script src="../../../web-component-tester/browser.js"></script>

    <link rel="import" href="../../../polymer/polymer.html">

    <!-- Step 1: import the element to test -->
    <link rel="import" href="../../src/juicy-tile-grid.html">
    <style>
    html,body{
      min-width: 0;
      font-size: 10px;
    }
    juicy-tile-grid{
      position: relative;
    }
    juicy-tile-grid > *{
      background-color: rgba(99,99,99,0.3);
      height: 100%;
      margin: 0;
    }
    juicy-tile-grid /deep/ #container{
      background-color: lightgrey;
    }
    juicy-tile-grid /deep/ .juicy-tile{
      background-color: lightblue;
      /*border: 1px solid black;*/
      /*box-sizing: border-box;*/
    }
    juicy-tile-grid /deep/ .juicy-tile:nth-child(2n){
      /*background-color: darkblue;*/
      /*border: 1px solid black;*/
      /*box-sizing: border-box;*/
    }
    </style>
  </head>
  <body>

    <!-- You can use the document as a place to set up your fixtures. -->
    <template is="dom-bind" id="root">
      <juicy-tile-grid id="grid0" setup="{{model.setup}}" style="width: 420px;<!--  visibility: hidden; -->"><!-- to 1300-->
        <div>100px x 100px</div>
        <div>200px x 100px <br/>flexible</div>
        <div>100px x 100px <br/>flexible</div>
        <div>100% x 100px <br/>flexible</div>
        <div>50% x 100px <br/>flexible</div>
      </juicy-tile-grid>
      <juicy-tile-grid id="grid1" setup="{{model.setup}}" style="width: 420px; <!-- visibility: hidden; -->"><!-- to 1300-->
        <div>100px x 100px</div>
        <div>200px x 100px <br/>flexible</div>
        <div>100px x 100px <br/>flexible</div>
        <div>100% x 100px <br/>flexible</div>
        <div>50% x 100px <br/>flexible</div>
      </juicy-tile-grid>
      <juicy-tile-grid id="grid2" setup="{{model.setup2}}" style="height: 420px; width: 320px<!-- visibility: hidden; -->"><!-- to 1300-->
        <div>100px x 100px</div>
        <div>200px x 100px <br/>flexible</div>
        <div>100px x 100px <br/>flexible</div>
        <div>100% x 100px <br/>flexible</div>
        <div>50% x 100px <br/>flexible</div>
      </juicy-tile-grid>
    </template>
    </template>
    <script>
var templ = document.getElementById('root');
var model = {
  width: 450,
  setup : {
    gutter: 10,
    items:[
      {
          id:0,
          priority:0.9,
          height: 100,
          width: 100
      },
      {
          id:1,
          priority:0.6,
          height: 100,
          width:200,
          widthFlexible: true
      },
      {
          id:2,
          priority:0.4,
          height: 100,
          width: 100,
          widthFlexible: true
      },
      {
          id:3,
          priority:0.4,
          height: 100,
          width: "100%",
          widthFlexible: true
      },
      {
          id:4,
          priority:0.4,
          height: 100,
          width: "50%",
          widthFlexible: true
      }
    ]
  },
  setup2 : {
    gutter: 10,
    direction: "vertical",
    items:[
      {
          id:0,
          priority:0.9,
          width: 100,
          height: 100
      },
      {
          id:1,
          priority:0.6,
          width: 100,
          height:200,
          heightFlexible: true
      },
      {
          id:2,
          priority:0.4,
          width: 100,
          height: 100,
          heightFlexible: true
      },
      {
          id:3,
          priority:0.4,
          width: 100,
          height: "100%",
          heightFlexible: true
      },
      {
          id:4,
          priority:0.4,
          width: 100,
          height: "50%",
          heightFlexible: true
      }
    ]
  }
};

document.querySelector("template").model = model;


function expectPosition(element, x, y){
  expect( element.offsetTop).to.equal(x);
  expect( element.offsetLeft).to.equal(y);
}
function expectPosition_yx(element, y, x){
	return expectPosition(element, x, y);
}
function expectSize(element, width, height){
  expect( element.offsetWidth).to.equal(width);
  expect( element.offsetHeight).to.equal(height);
}
function expectSize_hw(element, height, width){
	return expectSize(element, width, height);
}
/**
 * juicy-tile-grid fractions tests
 */
var juicyTileList;
describe('fractions', function() {
  before(function(done){
    setTimeout(function(){
    // Polymer.whenReady(function(){
      done();
      juicyTileList = document.getElementById('grid1');
      juicyTileList_height = document.getElementById('grid2');
    },100);
  });
  context('with widthFlexible', function () {
    afterEach(function(){
      juicyTileList.refresh.restore && juicyTileList.refresh.restore();
    });

    context('when rendered, ', function () {
      it('should align items in correct places', function (done) {
        expectPosition( juicyTileList.children[0], 0, 0);
        expectPosition( juicyTileList.children[1], 0, 100+10);
        expectPosition( juicyTileList.children[2], 0, 100+10+200+10);
        expectPosition( juicyTileList.children[3], 100+10, 0);
        expectPosition( juicyTileList.children[4], 100+10+100+10, 0);
        done();
      });
      it('should align items in correct sizes (Chrome seems to fail with rounding)', function (done) {
        expectSize( juicyTileList.children[0], 100, 100);
        expectSize( juicyTileList.children[1], 200, 100);
        expectSize( juicyTileList.children[2], 100, 100);
        expectSize( juicyTileList.children[3], 100+10+200+10+100, 100);
        expectSize( juicyTileList.children[4], (100+10+200+10+100)/2 - 10/2, 100);
        done();
      });

    });
    context('when resized', function () {
      it('refresh method should not be called', function (done) {
        var refresh = sinon.spy(juicyTileList, "refresh");

        juicyTileList.style.width = (450+100+100+230)+"px";

        // wait for mutation observer callback
        setTimeout(function whenMutated(){
          expect( juicyTileList.refresh.callCount ).to.equal(0);
          done();
        },10);
      });
      it('added width should be distributed proportionally among columns with items marked as expandable', function (done) {
        juicyTileList.style.width = (420+100+100+200)+"px";

        // wait for mutation observer callback
        setTimeout(function whenMutated(){
        expectPosition( juicyTileList.children[0], 0, 0);
        expectPosition( juicyTileList.children[1], 0, 100*2+10);
        expectPosition( juicyTileList.children[2], 0, 100*2+10+200*2+10);
        expectPosition( juicyTileList.children[3], 100+10, 0);
        expectPosition( juicyTileList.children[4], 100+10+100+10, 0);
        done();
        });
      });
      it('items marked as expandable should change size accordingly', function (done) {
        juicyTileList.style.width = (420+100+100+200)+"px";

        // wait for mutation observer callback
        setTimeout(function whenMutated(){
        expectSize( juicyTileList.children[0], 100, 100);
        expectSize( juicyTileList.children[1], 200*2, 100);
        expectSize( juicyTileList.children[2], 100*2, 100);
        expectSize( juicyTileList.children[3], 100*2+10+200*2+10+100*2, 100);
        expectSize( juicyTileList.children[4], 2*((420)/2 - 10/2) - 10, 100);
        done();
        });
      });

    });

  });


  context('with heightFlexible', function () {
    afterEach(function(){
      juicyTileList_height.refresh.restore && juicyTileList_height.refresh.restore();
    });

    context('when rendered, ', function () {
      it('should align items in correct places', function (done) {
        expectPosition_yx( juicyTileList_height.children[0], 0, 0);
        expectPosition_yx( juicyTileList_height.children[1], 0, 100+10);
        expectPosition_yx( juicyTileList_height.children[2], 0, 100+10+200+10);
        expectPosition_yx( juicyTileList_height.children[3], 100+10, 0);
        expectPosition_yx( juicyTileList_height.children[4], 100+10+100+10, 0);
        done();
      });
      it('should align items in correct sizes (Chrome seems to fail with rounding)', function (done) {
        expectSize_hw( juicyTileList_height.children[0], 100, 100);
        expectSize_hw( juicyTileList_height.children[1], 200, 100);
        expectSize_hw( juicyTileList_height.children[2], 100, 100);
        expectSize_hw( juicyTileList_height.children[3], 100+10+200+10+100, 100);
        expectSize_hw( juicyTileList_height.children[4], (100+10+200+10+100)/2 - 10/2, 100);
        done();
      });

    });
    context('when resized', function () {
      it('refresh method should not be called', function (done) {
        var refresh = sinon.spy(juicyTileList_height, "refresh");

        juicyTileList_height.style.height = (450+100+100+230)+"px";

        // wait for mutation observer callback
        setTimeout(function whenMutated(){
          expect( juicyTileList_height.refresh.callCount ).to.equal(0);
          done();
        },10);
      });
      it('added height should be distributed proportionally among columns with items marked as expandable', function (done) {
        juicyTileList_height.style.height = (420+100+100+200)+"px";

        // wait for mutation observer callback
        setTimeout(function whenMutated(){
        expectPosition_yx( juicyTileList_height.children[0], 0, 0);
        expectPosition_yx( juicyTileList_height.children[1], 0, 100*2+10);
        expectPosition_yx( juicyTileList_height.children[2], 0, 100*2+10+200*2+10);
        expectPosition_yx( juicyTileList_height.children[3], 100+10, 0);
        expectPosition_yx( juicyTileList_height.children[4], 100+10+100+10, 0);
        done();
        });
      });
      it('items marked as expandable should change size accordingly', function (done) {
        juicyTileList_height.style.height = (420+100+100+200)+"px";

        // wait for mutation observer callback
        setTimeout(function whenMutated(){
        expectSize_hw( juicyTileList_height.children[0], 100, 100);
        expectSize_hw( juicyTileList_height.children[1], 200*2, 100);
        expectSize_hw( juicyTileList_height.children[2], 100*2, 100);
        expectSize_hw( juicyTileList_height.children[3], 100*2+10+200*2+10+100*2, 100);
        expectSize_hw( juicyTileList_height.children[4], 2*((420)/2 - 10/2) - 10, 100);
        done();
        });
      });

    });

  });
});

    </script>

  </body>
</html>
